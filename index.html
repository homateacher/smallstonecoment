<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>조약돌 마을 · 이모티콘 멘트 추천 앱</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --olive-50:#EFF5E6; --olive-100:#DDECC7; --olive-200:#C8DDB2; --olive-300:#B0D094;
      --olive-700:#166534; --olive-800:#14532d; --olive-900:#0f3d22;
      --brown-200:#CBB89D; --brown-300:#BFA888;
    }
    html,body{height:100%;}
    body{font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Malgun Gothic","맑은 고딕",sans-serif;}
    .chip{border:1px solid rgb(209 250 229); background:rgba(236,253,245,.7); color:#065f46; padding:.15rem .5rem; border-radius:9999px; font-size:10px;}
    .btn{border-radius:12px; padding:.5rem .75rem; font-weight:600;}
    .btn-olive{background:#059669; color:#fff;} .btn-olive:hover{background:#047857;}
    .btn-lite{background:#e7e5e4; color:#111827;} .btn-lite:hover{background:#d6d3d1;}
    .toast{position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#065f46; color:#fff; padding:.5rem .75rem; border-radius:10px; font-size:.85rem; opacity:0; transition:opacity .2s, transform .2s;}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0);}
  </style>
</head>
<body class="min-h-screen w-full relative p-4 sm:p-6" style="background:linear-gradient(to bottom,var(--olive-50),var(--olive-100))">
  <!-- 배경 장식 -->
  <div class="pointer-events-none absolute inset-0" aria-hidden="true">
    <div class="absolute -top-24 -right-24 h-72 w-72 rounded-full blur-3xl opacity-40"
         style="background:radial-gradient(circle at center,var(--olive-200) 0%, var(--olive-300) 60%, transparent 70%)"></div>
    <div class="absolute -bottom-16 -left-10 h-80 w-80 rounded-full blur-3xl opacity-30"
         style="background:radial-gradient(circle at center,var(--brown-200) 0%, var(--brown-300) 60%, transparent 70%)"></div>
  </div>

  <div class="relative mx-auto max-w-5xl">
    <!-- 헤더: 좌측 로고 / 우측 타이틀 -->
    <div class="mb-4 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2">
      <div class="inline-flex items-center gap-2 text-2xl sm:text-3xl font-extrabold tracking-tight" style="color:var(--olive-800)">
        <span class="px-2 py-0.5 rounded-lg" style="background:#d1fae5; color:#047857; border:1px solid #a7f3d0">조약돌 마을</span>
      </div>
      <div class="text-xl sm:text-2xl font-extrabold tracking-tight" style="color:var(--olive-900)">
        이모티콘 <span style="color:#065f46">멘트 추천</span> 앱
        <span class="ml-2 text-xs align-top font-semibold text-stone-500">v0.8</span>
      </div>
    </div>

    <!-- 탭 -->
    <div class="w-full">
      <div class="grid grid-cols-2 w-full mb-4 rounded-xl" style="background:#d1fae5">
        <button id="tab-make-btn" class="py-2 font-semibold">추천 만들기</button>
        <button id="tab-favs-btn" class="py-2 font-semibold text-stone-500">즐겨찾기</button>
      </div>

      <!-- 추천 만들기 -->
      <div id="tab-make" class="rounded-2xl border border-emerald-200/60 bg-white/80 backdrop-blur p-4 sm:p-6 space-y-4">
        <!-- 컨트롤 -->
        <div class="grid grid-cols-1 sm:grid-cols-5 gap-3">
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">보내는 사람(화자)</div>
            <select id="speaker" class="w-full rounded-xl border p-2"></select>
          </div>
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">받는 사람(청자)</div>
            <select id="listener" class="w-full rounded-xl border p-2"></select>
          </div>
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">장소</div>
            <select id="place" class="w-full rounded-xl border p-2"></select>
          </div>
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">주제(키워드)</div>
            <input id="topic" class="w-full rounded-xl border p-2" placeholder="예: 고마움, 응원, 사랑, 위로, 미안, 약속..." />
            <div class="text-[10px] text-emerald-900/60 mt-1">예: "감사/thanks, 응원/cheer, 공부/study"</div>
          </div>
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">말투</div>
            <select id="style" class="w-full rounded-xl border p-2">
              <option value="formal">존댓말</option>
              <option value="casual" selected>반말</option>
              <option value="dialect">사투리</option>
              <option value="cute">귀여운</option>
              <option value="terse">건조(짧게)</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">길이 제한 (글자 수)</div>
            <input id="len" type="range" min="2" max="8" value="8" class="w-full" />
            <div class="text-[10px] text-emerald-900/60 mt-1">현재 <span id="lenLabel">8</span>자 이하 (최대 8자)</div>
          </div>
          <div>
            <div class="text-xs text-emerald-900/70 mb-1">추천 개수</div>
            <input id="count" type="number" value="24" min="1" max="60" class="w-full rounded-xl border p-2" />
          </div>
          <div class="flex items-end gap-2">
            <button id="rand" class="btn btn-olive">랜덤 채우기</button>
            <button id="reshuffle" class="btn btn-lite">새로 추천</button>
          </div>
        </div>

        <!-- 현재 조건 뱃지 -->
        <div class="flex flex-wrap gap-2 text-xs" id="chips"></div>

        <!-- 추천 목록 -->
        <div id="list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 pt-2"></div>
      </div>

      <!-- 즐겨찾기 -->
      <div id="tab-favs" class="hidden rounded-2xl border border-emerald-200/60 bg-white/80 backdrop-blur p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <div class="font-semibold">내 즐겨찾기</div>
          <button id="clearFavs" class="btn btn-lite">모두 비우기</button>
        </div>
        <div id="favEmpty" class="text-emerald-900/70 text-sm">아직 즐겨찾기가 없어요. 카드의 ★ 를 눌러 저장해보세요.</div>
        <div id="favs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">복사 완료!</div>

  <script>
  /* ===================== 데이터 ===================== */
  // 50개 역할(화자/청자 공통) — tone은 기본 선호(가중치용)
  const ROLES = [
    ["me","나","either",["friend"]],["we","우리","either",["group"]],
    ["friend","친구","casual",["friend"]],["bestie","베프","casual",["friend"]],
    ["lover","연인","casual",["friend"]],["spouse","배우자","casual",["family"]],
    ["fiance","약혼자","casual",["friend","family"]],["crush","썸","casual",["friend"]],
    ["mom","엄마","casual",["family","elder"]],["dad","아빠","casual",["family","elder"]],
    ["parents","부모님","formal",["family","elder"]],["son","아들","casual",["family","younger"]],
    ["daughter","딸","casual",["family","younger"]],["bro","형/오빠","casual",["family","elder"]],
    ["sis","누나/언니","casual",["family","elder"]],["yngsibling","동생","casual",["family","younger"]],
    ["grand","할머니/할아버지","formal",["family","elder"]],["auntuncle","이모/삼촌","formal",["family","elder"]],
    ["cousin","사촌","casual",["family"]],["inlaw","시댁/처가","formal",["family","elder"]],

    ["teacher","선생님","formal",["school","elder"]],["prof","교수님","formal",["school","elder"]],
    ["homeroom","담임선생님","formal",["school","elder"]],["senior","선배","formal",["school","elder"]],
    ["junior","후배","casual",["school","younger"]],["classmate","반친구","casual",["school","friend"]],
    ["clubmate","동아리친구","casual",["school","friend"]],["coach","코치","formal",["school","sports"]],

    ["boss","상사","formal",["work","elder"]],["ceo","사장님","formal",["work","elder"]],
    ["lead","팀장님","formal",["work","elder"]],["manager","매니저","formal",["work","elder"]],
    ["coworker","동료","either",["work"]],["hr","인사팀","formal",["work"]],
    ["client","고객사","formal",["work","service"]],["customer","고객","formal",["service"]],
    ["vendor","협력업체","formal",["work"]],["partner","파트너사","formal",["work"]],
    ["intern","인턴","casual",["work","younger"]],["team","팀원","either",["work","group"]],

    ["barista","바리스타","formal",["service"]],["cashier","계산원","formal",["service"]],
    ["delivery","배달기사님","formal",["service"]],["driver","기사님","formal",["service"]],
    ["doctor","의사선생님","formal",["service","elder"]],["nurse","간호사님","formal",["service"]],
    ["pharmacist","약사님","formal",["service"]],["trainer","트레이너","formal",["sports","service"]],
    ["pastor","목사님","formal",["community","elder"]],["mentor","멘토","formal",["community"]],
    ["neighbor","이웃","either",["community"]],["roommate","룸메","casual",["community","friend"]],
    ["landlord","집주인","formal",["community","elder"]],["guard","경비원님","formal",["community","service"]],
    ["librarian","사서님","formal",["service","school"]],["police","경찰관님","formal",["service"]],
  ];
  const SPEAKERS = ROLES.map(([id,label,tone,groups])=>({id,label,tone,groups}));
  const LISTENERS = ROLES.map(([id,label,tone,groups])=>({id,label,tone,groups}));

  // 장소 + '선택 안 함'
  const PLACES = [
    { id:"any", label:"선택 안 함", groups:[] },
    { id:"chat",label:"채팅중",groups:["chat"] }, { id:"home",label:"집",groups:["home"] },
    { id:"school",label:"학교",groups:["school"] }, { id:"class",label:"수업",groups:["school"] },
    { id:"office",label:"회사",groups:["work"] }, { id:"cafe",label:"카페",groups:["service"] },
    { id:"restaurant",label:"식당",groups:["service"] }, { id:"subway",label:"지하철",groups:["travel"] },
    { id:"bus",label:"버스",groups:["travel"] }, { id:"street",label:"길거리",groups:["travel"] },
    { id:"gym",label:"체육관",groups:["sports"] }, { id:"hospital",label:"병원",groups:["service"] },
    { id:"park",label:"공원",groups:["community"] }, { id:"library",label:"도서관",groups:["school","community"] },
    { id:"market",label:"마트",groups:["service"] }, { id:"travel",label:"여행",groups:["travel"] },
    { id:"airport",label:"공항",groups:["travel"] }, { id:"hotel",label:"호텔",groups:["travel","service"] },
    { id:"church",label:"교회",groups:["community"] }, { id:"studyroom",label:"스터디룸",groups:["school"] },
  ];

  // 주제 표준화
  const TOPIC_MAP = {
    "고마움":"thanks","감사":"thanks","thanks":"thanks",
    "응원":"cheer","화이팅":"cheer","격려":"cheer","칭찬":"cheer",
    "사랑":"love","애정":"love","위로":"comfort",
    "미안":"apology","사과":"apology",
    "약속":"promise","기다려":"promise",
    "안녕":"greeting","하이":"greeting","잘가":"farewell","굿밤":"goodnight",
    "축하":"congrats","생일":"birthday","기념일":"anniv",
    "지각":"late","늦음":"late","바쁨":"busy","아파":"sick","감기":"sick",
    "공부":"study","일":"work","업무":"work","회의":"work"
  };

  // 템플릿(고정 + 어근 조합) — 8자 자동 필터
  const TEMPLATES = {
    greeting: { fixed: [["안녕!","either",[]],["안녕하세요","formal",[]],["하이하이","casual",[]],["반가워요","formal",[]],["반가워","casual",[]],["좋은아침","either",[]],["왔어?","casual",["friend"]],["왔어요?","formal",[]]] },
    farewell: { fixed: [["잘가요","formal",[]],["잘가","casual",[]],["또 보자","casual",["friend"]],["또 봬요","formal",[]],["다음에 봐","either",[]],["이따 봐","either",["chat"]]] },
    thanks: {
      stems: [["감사",["합니다","해요","해요!"],"formal",[]],["고맙",["습니다","습니다!"],"formal",[]]],
      fixed: [["고마워","casual",["friend"]],["고마워!","casual",["friend"]],["덕분이에요","formal",[]],["덕분이야","casual",[]],["정말감사","either",[]],["늘 고마워","casual",["friend"]]]
    },
    cheer: {
      fixed: [["화이팅!","either",[]],["파이팅!","either",[]],["힘내요!","formal",[]],["힘내!","casual",[]],["넌 최고","casual",["friend"]],["최고에요","formal",[]],["잘했어!","casual",[]],["잘했어요","formal",[]],["멋져요","formal",[]],["대박이야","casual",[]]],
      stems: [["집중",["하자","!"," 부탁"],"either",["work","study"]],["끝까지",["가자","간다!"],"either",["work"]]]
    },
    love: { fixed: [["사랑해","casual",["friend"]],["좋아해","casual",[]],["보고싶어","casual",[]],["아끼어요","formal",[]],["내 편이야","casual",[]],["곁에있어","either",[]],["함께해","either",["team"]]] },
    comfort: { fixed: [["괜찮아요","formal",[]],["괜찮아","casual",[]],["천천히 해","either",[]],["네 탓 아냐","either",[]],["내가 들을게","either",[]],["힘들었지","casual",[]],["수고했어","casual",[]],["수고하셨어요","formal",[]]] },
    apology: { stems: [["죄송",["합니다","해요"],"formal",[]],["미안",["해","해요"],"either",[]]], fixed: [["내 실수야","casual",[]],["다음엔 더","either",[]]] },
    promise: { fixed: [["곧 가요","formal",["travel"]],["곧갈게","casual",["travel"]],["금방가요","formal",["travel"]],["금방가!","casual",["travel"]],["곧 도착","either",["travel"]],["기다려줘","either",["love"]],["연락줘","either",["chat"]],["이따 봐","either",["chat"]]] },
    birthday: { fixed: [["생일 축하","either",[]],["해피데이","either",[]],["축하해요","formal",[]],["축하해","casual",[]]] },
    anniv: { fixed: [["우리의 날","either",[]],["함께라 좋아","either",[]]] },
    late: { fixed: [["조금 늦음","either",["travel"]],["길 막혀","either",["travel"]],["먼저 가","either",["travel"]]] },
    busy: { fixed: [["바쁠 땐 톡","either",["work","school"]],["잠시만요","formal",[]],["조금만요","formal",[]]] },
    sick: { fixed: [["몸 챙겨","either",[]],["감기 조심","either",[]],["약 먹어","casual",[]],["물 마셔","either",[]],["따뜻이 입어","either",[]],["쉬자","casual",[]],["편히 쉬어요","formal",[]]] },
    study:{ fixed: [["수업 시작","either",["school"]],["숙제 했니?","casual",["school"]],["집중하자","either",["school"]],["조용히 해","either",["school"]],["끝나고 톡","either",["school","work"]]] },
    work:{ fixed: [["회의 고고","either",["work"]],["자료 부탁","formal",["work"]],["회신 부탁","formal",["work"]],["지금 가능?","either",["work","chat"]],["좋아요","either",["work"]]] },
    cafe:{ fixed: [["커피 한 잔","either",["service"]],["자리 있어","either",["service"]],["자리 없니?","casual",["service"]]] },
    sports:{ fixed: [["굿플레이","either",["sports"]],["패스 줘!","casual",["sports"]],["팀 고!","either",["sports","team"]]] },
    goodnight: { fixed: [["잘자요","formal",["love"]],["잘 자","casual",["love"]]] },
  };

  const withinLimit = (s,limit)=> (s??"").trim().length <= limit;

  function buildPhrases(){
    const out = [];
    const add = (text,topic,tone,groups=[])=>{
      if(!withinLimit(text,8)) return;
      out.push({t:text,topic,tone,groups});
    }
    for(const [topic,conf] of Object.entries(TEMPLATES)){
      (conf.fixed||[]).forEach(([txt,tone,groups])=>add(txt,topic,tone,groups));
      (conf.stems||[]).forEach(([stem,ends,tone,groups])=>{ ends.forEach(end=>add(stem+end,topic,tone,groups)); });
    }
    // 관계/장소 특화 보강
    [["엄마 사랑","love","casual",["family","elder"]],
     ["선생님 감사","thanks","formal",["school","elder"]],
     ["회의 후 톡","work","formal",["work"]],
     ["산책 갈래","love","casual",["home","travel"]],
     ["영화 볼까","love","casual",["home","travel"]],
     ["곧 출발","promise","either",["travel"]],
     ["도착했어","promise","either",["travel"]],
     ["평안하세요","comfort","formal",["community"]],
     ["축복해요","comfort","formal",["community"]],
     ["기도할게","comfort","either",["community"]],
     ["굿잡!","cheer","either",["work"]],
     ["나이스","cheer","either",["sports"]],
     ["반가워요","greeting","formal",[]],
     ["반가워","greeting","casual",[]]]
     .forEach(([t,topic,tone,groups])=>add(t,topic,tone,groups));
    return out;
  }
  const PHRASES = buildPhrases(); // 400개+

  /* ===================== 말투 변환 ===================== */
  // style: formal / casual / dialect / cute / terse
  const shortMap = new Map([
    ["감사합니다","감사"],["감사해요","감사"],["감사","감사"],
    ["고마워요","고마워"],["괜찮아요","괜찮아"],["괜찮을 거야","괜찮아"],
    ["사랑해요","사랑해"],["축하해요","축하"],["축하해","축하"],
    ["잘했어요","잘했어"],["수고하셨어요","수고했어"],["수고했어","수고"],
    ["생일 축하","축하"],["좋은아침","아침굿"],["조금 늦음","지각중"],
    ["이따 봐","이따봐"],["곧 도착","곧도착"],["연락줘","연락좀"],
  ]);

  function toFormal(t){
    // 평서/명령을 가능한 '요/니다'로
    let s=t;
    s=s.replace(/!$/,""); // 느낌표 제거
    s=s.replace(/해$/,"해요").replace(/해\?$/,"하나요?");
    s=s.replace(/가!$/,"가요").replace(/가$/,"가요");
    s=s.replace(/왔어\?/,"왔어요?");
    if(!/[요|니다|세요|\?]$/.test(s)) s += "요";
    return fit8(s);
  }
  function toCasual(t){
    let s=t;
    s=s.replace(/합니다$/,"해").replace(/해요!?$/,"해").replace(/세요$/,"해");
    s=s.replace(/가요$/,"가").replace(/왔어요\?/,"왔어?");
    s=s.replace(/요$/,"");
    return fit8(s);
  }
  function toDialect(t){
    // 가벼운 부산권 느낌: ~데이, ~하이, ~심다
    let s=toCasual(t);
    s=s.replace(/고마워/g,"고맙데이").replace(/감사/g,"고맙심다");
    s=s.replace(/사랑해/g,"사랑한데이").replace(/미안해/g,"미안하이");
    s=s.replace(/괜찮아/g,"괜찮데이").replace(/가$/,"간다").replace(/봐$/,"보자");
    return fit8(s);
  }
  function toCute(t){
    let s=t;
    s=s.replace(/요$/,"용").replace(/해$/,"해용").replace(/가$/,"가용").replace(/자$/,"자아").replace(/줘$/,"줘용");
    if(s.length<=7 && !/[♡]/.test(s)) s += "♡"; // 여유 있으면 하트
    return fit8(s);
  }
  function toTerse(t){
    let s = shortMap.get(t) || t;
    s=s.replace(/\s+/g,""); // 공백 제거로 짧게
    s=s.replace(/해요|합니다|하세요|합니다/g,"해");
    s=s.replace(/가요/g,"가");
    if(s.length>8) s=s.slice(0,8);
    return s;
  }
  function fit8(s){ return s.length>8 ? s.slice(0,8) : s; }

  function applyStyle(text, style){
    switch(style){
      case "formal": return toFormal(text);
      case "casual": return toCasual(text);
      case "dialect": return toDialect(text);
      case "cute":   return toCute(text);
      case "terse":  return toTerse(text);
      default: return text;
    }
  }

  /* ===================== 스코어링 ===================== */
  // style→tone 기대치(가중치 계산용)
  const styleTone = (style)=> style==="formal" ? "formal" : "casual";

  function topicOf(raw){ if(!raw) return null; const key=raw.trim().toLowerCase(); for(const [k,v] of Object.entries(TOPIC_MAP)){ if(k.toLowerCase()===key) return v; } return null; }
  const toastMsg = (msg)=>{ const el=document.getElementById("toast"); el.textContent=msg; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1200); };

  function scorePhrase(ph, ctx){
    // 길이 체크는 스타일 변환 후에 할 거라 여기선 base만
    let s = 0;
    // 1) 주제(가장 중요)
    if(ctx.topic && ph.topic===ctx.topic) s += 6;

    // 2) 관계/장소 그룹 매칭
    const bag = new Set([...(ctx.speaker.groups||[]), ...(ctx.listener.groups||[]), ...(ctx.place?.groups||[])]);
    const hit = (ph.groups||[]).filter(g=>bag.has(g)).length;
    s += hit * 3;

    // 3) 장소가 '선택 안 함'이면 패널티/보너스 없음, 아닌 경우 약한 보정
    if(ctx.place && ctx.place.id!=="any"){
      if(ctx.place.groups.some(g=> (ph.groups||[]).includes(g))) s += 2;
    }

    // 4) 말투 기대치(청자 기본 톤 vs 선택한 말투)
    const want = styleTone(ctx.style);
    if(ctx.listener.tone==="formal" && want==="formal") s += 2;
    if(ctx.listener.tone==="casual" && want==="casual") s += 2;
    if(ctx.listener.tone==="formal" && want==="casual") s -= 1;
    if(ctx.listener.tone==="casual" && want==="formal") s -= 0.5;

    // 5) 짧을수록 약간 가산(최종 변환 후 재가중)
    s += (8 - Math.min(ph.t.length,8)) * 0.15;

    return s;
  }

  /* ===================== UI/상태 ===================== */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const fillSelect=(el,items)=>{ el.innerHTML=items.map(o=>`<option value="${o.id}">${o.label}</option>`).join(""); }
  fillSelect($("#speaker"), SPEAKERS);
  fillSelect($("#listener"), LISTENERS);
  fillSelect($("#place"), PLACES);

  const state = {
    speaker: SPEAKERS[0],
    listener: LISTENERS[1],
    place: PLACES[0], // 선택 안 함
    topic: "",
    style: "casual",
    len: 8,
    count: 24,
    favs: JSON.parse(localStorage.getItem("emo-favs")||"[]")
  };

  function renderChips(){
    const t = topicOf(state.topic);
    $("#chips").innerHTML = `
      ${t ? `<span class="chip">주제: ${t}</span>` : ""}
      <span class="chip">보내는 사람: ${state.speaker.label}</span>
      <span class="chip">받는 사람: ${state.listener.label}</span>
      <span class="chip">장소: ${state.place.label}</span>
      <span class="chip">말투: ${({"formal":"존댓말","casual":"반말","dialect":"사투리","cute":"귀여운","terse":"건조"})[state.style]}</span>
    `;
  }

  function recommend(){
    const ctx = { topic: topicOf(state.topic), len: state.len, style: state.style, speaker: state.speaker, listener: state.listener, place: state.place };
    const scored = PHRASES.map(p=>({p, s: scorePhrase(p,ctx)})).sort((a,b)=>b.s-a.s);

    // 상위 후보 추림 + 길이/말투 변환 적용 + 재가중(짧을수록 가산)
    const candidates = [];
    for(const {p, s} of scored.slice(0,220)){
      const styled = applyStyle(p.t, state.style);
      if(!withinLimit(styled, state.len)) continue;
      let score = s + (8 - styled.length) * 0.2; // 최종 길이 보정
      candidates.push({ text: styled, meta:p, score });
    }

    // 다양성 섞기 + 중복 제거
    candidates.sort((a,b)=>b.score-a.score);
    const shuffled = [...candidates.slice(0,160)].sort(()=>Math.random()-0.35);
    const pick=[]; const seen=new Set();
    for(const c of shuffled){
      if(seen.has(c.text)) continue;
      seen.add(c.text); pick.push(c);
      if(pick.length>=state.count) break;
    }

    // 렌더
    $("#list").innerHTML = pick.map(cardHTML).join("");
    bindCardEvents();
  }

  function cardHTML(c){
    const t=c.text, p=c.meta, starred = state.favs.includes(t);
    return `
      <div class="rounded-2xl border bg-white/90 hover:shadow transition-shadow p-3">
        <div class="flex items-start justify-between gap-2">
          <div class="text-base font-semibold leading-snug break-keep">${t}</div>
          <div class="flex items-center gap-1">
            <button class="btn-lite px-2 py-1 text-xs copy" data-t="${t}">복사</button>
            <button class="btn-lite px-2 py-1 text-xs star" data-t="${t}" aria-label="즐겨찾기">${starred?"★":"☆"}</button>
          </div>
        </div>
        <div class="mt-2 flex flex-wrap gap-1">
          ${p.topic?`<span class="chip">${p.topic}</span>`:""}
          ${(p.groups||[]).slice(0,2).map(x=>`<span class="chip">${x}</span>`).join("")}
        </div>
      </div>
    `;
  }

  function bindCardEvents(){
    $$(".copy").forEach(b=>b.addEventListener("click", async (e)=>{
      const t=e.currentTarget.getAttribute("data-t"); await navigator.clipboard.writeText(t); toastMsg("복사 완료!");
    }));
    $$(".star").forEach(b=>b.addEventListener("click",(e)=>{
      const t=e.currentTarget.getAttribute("data-t");
      const i=state.favs.indexOf(t);
      if(i>=0) state.favs.splice(i,1); else state.favs.unshift(t);
      localStorage.setItem("emo-favs", JSON.stringify(state.favs));
      refreshFavs(); recommend();
    }));
  }

  function refreshFavs(){
    const empty = $("#favEmpty"); const grid=$("#favs");
    if(state.favs.length===0){ empty.classList.remove("hidden"); grid.innerHTML=""; return; }
    empty.classList.add("hidden");
    grid.innerHTML = state.favs.map(t=>`
      <div class="rounded-2xl border bg-white/90 p-3 flex items-start justify-between gap-2">
        <div class="text-base font-semibold break-keep">${t}</div>
        <div class="flex gap-1">
          <button class="btn-lite px-2 py-1 text-xs copy" data-t="${t}">복사</button>
          <button class="btn-lite px-2 py-1 text-xs unstar" data-t="${t}">삭제</button>
        </div>
      </div>`).join("");
    $$(".copy").forEach(b=>b.addEventListener("click", async (e)=>{
      const t=e.currentTarget.getAttribute("data-t"); await navigator.clipboard.writeText(t); toastMsg("복사 완료!");
    }));
    $$(".unstar").forEach(b=>b.addEventListener("click",(e)=>{
      const t=e.currentTarget.getAttribute("data-t"); state.favs=state.favs.filter(x=>x!==t);
      localStorage.setItem("emo-favs", JSON.stringify(state.favs)); refreshFavs();
    }));
  }

  /* 이벤트 & 초기화 */
  const $sp = $("#speaker"), $li=$("#listener"), $pl=$("#place"), $style=$("#style");
  const fillSelectEl=(el, items, cur)=>{ el.innerHTML=items.map(o=>`<option value="${o.id}">${o.label}</option>`).join(""); el.value=cur.id; }
  fillSelectEl($sp, SPEAKERS, state.speaker);
  fillSelectEl($li, LISTENERS, state.listener);
  fillSelectEl($pl, PLACES, state.place);

  $sp.addEventListener("change",(e)=>{ state.speaker = SPEAKERS.find(x=>x.id===e.target.value); renderChips(); recommend(); });
  $li.addEventListener("change",(e)=>{ state.listener = LISTENERS.find(x=>x.id===e.target.value); renderChips(); recommend(); });
  $pl.addEventListener("change",(e)=>{ state.place = PLACES.find(x=>x.id===e.target.value); renderChips(); recommend(); });
  $("#topic").addEventListener("input",(e)=>{ state.topic=e.target.value; renderChips(); recommend(); });
  $("#len").addEventListener("input",(e)=>{ state.len=+e.target.value; document.getElementById("lenLabel").textContent=state.len; recommend(); });
  $("#count").addEventListener("input",(e)=>{ const v=Math.max(1,Math.min(60,+e.target.value||1)); state.count=v; recommend(); });
  $style.addEventListener("change",(e)=>{ state.style=e.target.value; renderChips(); recommend(); });

  $("#rand").addEventListener("click",()=>{
    const r = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    $sp.value = (state.speaker = r(SPEAKERS)).id;
    $li.value = (state.listener = r(LISTENERS)).id;
    $pl.value = (state.place = r(PLACES)).id;
    const topics = Object.keys(TOPIC_MAP);
    $("#topic").value = state.topic = r(topics);
    $("#style").value = state.style = r(["formal","casual","dialect","cute","terse"]);
    renderChips(); recommend();
  });
  $("#reshuffle").addEventListener("click",()=>{ window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"}); recommend(); });
  $("#clearFavs").addEventListener("click",()=>{ state.favs=[]; localStorage.setItem("emo-favs","[]"); refreshFavs(); });

  const toMake=()=>{$("#tab-make").classList.remove("hidden"); $("#tab-favs").classList.add("hidden");
    $("#tab-make-btn").classList.remove("text-stone-500"); $("#tab-favs-btn").classList.add("text-stone-500");}
  const toFavs=()=>{$("#tab-favs").classList.remove("hidden"); $("#tab-make").classList.add("hidden");
    $("#tab-favs-btn").classList.remove("text-stone-500"); $("#tab-make-btn").classList.add("text-stone-500"); refreshFavs();}
  $("#tab-make-btn").addEventListener("click",toMake); $("#tab-favs-btn").addEventListener("click",toFavs);

  renderChips(); recommend(); refreshFavs();
  </script>
</body>
</html>
